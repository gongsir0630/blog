
<!DOCTYPE html>
<html lang="zh-CN">
    <!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  
    <link rel="icon" href="https://thirdqq.qlogo.cn/qqapp/1110061270/E0B4163FDCD19C3791B49B64EDB9F688/100">
  
  
      <meta name="author" content="ç¨‹åºå‘˜Kyleâœ¨">
  
  
      <meta name="subtitle" content="ç¨‹åºå‘˜Kyleâœ¨çš„ä¸ªäººåšå®¢">
  
  
      <meta name="description" content="ç¨‹åºå‘˜Kyleâœ¨çš„ä¸ªäººåšå®¢,è®°å½•éšç¬”ä¸å­¦ä¹ ç¬”è®°ï¼ŒJavaåç«¯ç›¸å…³çš„çŸ¥è¯†ï¼Œä¸ªäººé¢ç»ç­‰">
  
  
      <meta name="keywords" content=",ç¨‹åºå‘˜Kyleâœ¨">
  
  
    <link rel="alternate" href="/blog/atom.xml " title="ç¨‹åºå‘˜Kyleâœ¨ï½œä¸ªäººåšå®¢" type="application/atom+xml">
  

  

  <title>åŸºäºShiro | JWTæ•´åˆWxJavaå®ç°å¾®ä¿¡å°ç¨‹åºç™»å½• | ç¨‹åºå‘˜Kyleâœ¨ï½œä¸ªäººåšå®¢</title>

  

  

  
      
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>


  

  <link rel="stylesheet" href="/blog/css/style.css" >
  <link rel="stylesheet" href="/blog/css/partial/dark.css" >

  
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&amp;display=swap"  media="print" onload="this.media='all'">
  
  
  

  
    
      <link rel="stylesheet" href="/blog/css/partial/highlight/atom-one-light.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/a2396837/CDN@latest/css/iconfont.css">
    
  

  
    <script src="/blog/js/todark.js"></script>
    
<meta name="generator" content="Hexo 5.2.0"></head>
</html>
    
<div class="nav index" style="height: 60px;">
    <div class="title animated fadeInDown">
        <div class="layui-container">
                <div class="nav-title"><a href="/blog/" title="ç¨‹åºå‘˜Kyleâœ¨ï½œä¸ªäººåšå®¢">ç¨‹åºå‘˜Kyleâœ¨ï½œä¸ªäººåšå®¢</a></div>
            <div class="nav-list">
                <button> <span class=""></span><span style="display: block;"></span><span class=""></span> </button>
                <ul class="layui-nav" lay-filter="">
                    
                        
                        
                        
                        
                    <li class="layui-nav-item">
                        <a href="/search/ ">
                            <i class=" fas fa-search-plus " style="color: rgb(3 169 244);"></i>
                            <span class="layui-nav-item-name">æœç´¢</span>
                        </a>
                    </li>
                    
                        
                        
                        
                        
                    <li class="layui-nav-item">
                        <a href="/ ">
                            <i class=" fab fa-fort-awesome " style="color: rgb(255 107 107);"></i>
                            <span class="layui-nav-item-name">é¦–é¡µ</span>
                        </a>
                    </li>
                    
                        
                        
                        
                        
                    <li class="layui-nav-item">
                        <a href="/archives/ ">
                            <i class=" fas fa-archive " style="color: rgb(10 189 227);"></i>
                            <span class="layui-nav-item-name">æ—¶é—´çº¿</span>
                        </a>
                    </li>
                    
                        
                        
                        
                        
                    <li class="layui-nav-item">
                        <a href="/tags/ ">
                            <i class=" fas fa-hashtag " style="color: rgb(254 202 87);"></i>
                            <span class="layui-nav-item-name">æ ‡ç­¾</span>
                        </a>
                    </li>
                    
                        
                        
                        
                        
                    <li class="layui-nav-item">
                        <a href="/categories ">
                            <i class=" far fa-folder-open " style="color: rgb(29 209 161);"></i>
                            <span class="layui-nav-item-name">åˆ†ç±»</span>
                        </a>
                    </li>
                    
                        
                        
                        
                        
                    <li class="layui-nav-item">
                        <a href="/about/ ">
                            <i class=" fab fa-grav " style="color: rgb(154 106 247);"></i>
                            <span class="layui-nav-item-name">å…³äº</span>
                        </a>
                    </li>
                    
                        
                        
                        
                        
                    <li class="layui-nav-item">
                        <a href="/guestbook/ ">
                            <i class=" fab fa-telegram " style="color: hsl(205deg 100% 50%);"></i>
                            <span class="layui-nav-item-name">ç•™è¨€</span>
                        </a>
                    </li>
                    
                        
                        
                        
                        
                    <li class="layui-nav-item">
                        <a href="/link/ ">
                            <i class=" fab fa-weixin " style="color: hsl(152deg 73% 45%);"></i>
                            <span class="layui-nav-item-name">å‹é“¾</span>
                        </a>
                    </li>
                    
                        
                        
                        
                        
                    <li class="layui-nav-item">
                        <a href="/shuoshuo/ ">
                            <i class=" fas fa-coffee " style="color:#31c7c1;"></i>
                            <span class="layui-nav-item-name">è¯´è¯´</span>
                        </a>
                    </li>
                    
                    
                        <li class="layui-nav-item" id="btn-toggle-dark">ğŸŒ™</li>
                    
                    <span class="layui-nav-bar" style="left: 342px; top: 78px; width: 0px; opacity: 0;"></span>
                </ul>
            </div>
        </div>
    </div>
</div>
    
<header class="header">
        
            <div class="logo">
                    <a href="/blog/"><img src="https://thirdqq.qlogo.cn/qqapp/1110061270/E0B4163FDCD19C3791B49B64EDB9F688/100" onerror=this.onerror=null,this.src="/blog/img/loading.gif"></a>
            </div>
         
    </div>
     

            <div class="motto">
                <span>ç”¨æˆ‘çš„æŒ‡å°–å®ç°æˆ‘çš„æŠ€æœ¯æ¢¦</span>
            </div>
    
    
            <div class="social">
                
                        <a class="social-icon" href="https://github.com/gongsir0630" target="_blank" title="Github">
                            <i class="iconfont icon-GitHub" aria-hidden="true"></i>
                          </a>
                 
                        <a class="social-icon" href="mailto:gongsir0630@gmail.com" target="_blank" title="Email">
                            <i class="iconfont icon-email" aria-hidden="true"></i>
                          </a>
                 
                        <a class="social-icon" href="https://space.bilibili.com/277602309" target="_blank" title="Bilibili">
                            <i class="iconfont icon-bilibili" aria-hidden="true"></i>
                          </a>
                 
                        <a class="social-icon" href="/atom.xml" target="_blank" title="rss">
                            <i class="iconfont icon-rss" aria-hidden="true"></i>
                          </a>
                 
            </div>
     
</header>

    
<article id="post">
  <div class="post-title">åŸºäºShiro | JWTæ•´åˆWxJavaå®ç°å¾®ä¿¡å°ç¨‹åºç™»å½•</div>
  
<div class="post-meta">
    
    
      <div class="post-meta-item date">
        <span title="å‘è¡¨äº 2021.03.26"><i class="far fa-calendar-alt"></i> 2021.03.26</span>
      </div>
      <div class="post-meta-item updated">
        <span title="æ›´æ–°äº 2023.07.30"><i class="far fa-calendar-check"></i> 2023.07.30</span>
      </div>
     
    
      <div class="post-meta-item categories">
        
          <i class="fas fa-inbox article-meta__icon"></i> <a href="/blog/categories/%E5%8E%9F%E5%88%9B/">åŸåˆ›</a>
        
          <i class="fas fa-inbox article-meta__icon"></i> <a href="/blog/categories/%E5%8E%9F%E5%88%9B/%E5%90%8E%E7%AB%AF/">åç«¯</a>
        
      </div>
     
    
     <div class="post-meta-item wordcount">
        
          <i class="fas fa-pencil-alt"></i> <span class="post-count">7.2k å­—</span>
           
        
          <i class="far fa-clock"></i> <span class="post-count">36 åˆ†é’Ÿ</span>
                               
      </div>
     
</div>


  
    <div id="toc" class="toc">
          <h1>ç›®å½•</h1>
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">2.</span> <span class="toc-text">ç‰¹æ€§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">3.</span> <span class="toc-text">å‡†å¤‡å·¥ä½œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%80%9D%E8%B7%AF"><span class="toc-number">4.</span> <span class="toc-text">æ•´ä½“æ€è·¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#token%E5%8A%A0%E5%AF%86%E8%AF%B4%E6%98%8E"><span class="toc-number">5.</span> <span class="toc-text">tokenåŠ å¯†è¯´æ˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#token%E6%A0%A1%E9%AA%8C%E8%AF%B4%E6%98%8E"><span class="toc-number">6.</span> <span class="toc-text">tokenæ ¡éªŒè¯´æ˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.</span> <span class="toc-text">é¡¹ç›®å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAMaven%E9%A1%B9%E7%9B%AE"><span class="toc-number">7.1.</span> <span class="toc-text">åˆ›å»ºMavené¡¹ç›®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE-%E5%B7%A5%E5%85%B7%E5%87%86%E5%A4%87"><span class="toc-number">7.2.</span> <span class="toc-text">ç›¸å…³é…ç½® | å·¥å…·å‡†å¤‡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEfastJson"><span class="toc-number">7.2.1.</span> <span class="toc-text">é…ç½®fastJson</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AERedis"><span class="toc-number">7.2.2.</span> <span class="toc-text">é…ç½®Redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AERestTemplate"><span class="toc-number">7.2.3.</span> <span class="toc-text">é…ç½®RestTemplate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E9%9B%86%E5%B0%81%E8%A3%85"><span class="toc-number">7.2.4.</span> <span class="toc-text">è¿”å›é›†å°è£…</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%B0%81%E8%A3%85%E4%B8%8E%E5%A4%84%E7%90%86"><span class="toc-number">7.2.5.</span> <span class="toc-text">å¼‚å¸¸å°è£…ä¸å¤„ç†</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">7.3.</span> <span class="toc-text">å‡†å¤‡æ•°æ®æº</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BAJWT"><span class="toc-number">7.4.</span> <span class="toc-text">æ„å»ºJWT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Realm%E9%85%8D%E7%BD%AE"><span class="toc-number">7.5.</span> <span class="toc-text">Realmé…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%86%99filter"><span class="toc-number">7.6.</span> <span class="toc-text">é‡å†™filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shiro%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE"><span class="toc-number">7.7.</span> <span class="toc-text">Shiroæ ¸å¿ƒé…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81"><span class="toc-number">7.8.</span> <span class="toc-text">éªŒè¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%90%8E"><span class="toc-number">8.</span> <span class="toc-text">æœ€å</span></a></li></ol>
      </div>
    
  <div class="content">
        <div><p>æ˜é‡‘åŸæ–‡ä½“éªŒæ›´åŠ <a target="_blank" rel="noopener" href="https://juejin.cn/post/6942706988534988836">ğŸ‘‰ğŸ‘‰æˆ³è¿™é‡Œ</a></p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘åœ¨åšæ¯•ä¸šè®¾è®¡ï¼Œæ¶‰åŠåˆ°å¾®ä¿¡å°ç¨‹åºçš„å¼€å‘ï¼Œè¦æ±‚å‰ç«¯å°ç¨‹åºç”¨æˆ·ä½¿ç”¨å¾®ä¿¡èº«ä»½ç™»å½•ï¼Œç™»é™†æˆåŠŸåï¼Œåå°è¿”å›è‡ªå®šä¹‰ç™»å½•çŠ¶æ€tokenç»™å°ç¨‹åºï¼Œåç»­å°ç¨‹åºå‘é€APIè¯·æ±‚éƒ½éœ€è¦æºå¸¦tokenæ‰èƒ½è®¿é—®åå°æ•°æ®ã€‚</p>
<p>æœ¬æ–‡æ˜¯å¯¹æ¥å¾®ä¿¡å°ç¨‹åºï¼Œå®ç°è‡ªå®šä¹‰ç™»å½•çŠ¶æ€çš„ä¸€ä¸ªå®Œæ•´ç¤ºä¾‹ï¼Œå®ç°äº†å°ç¨‹åºçš„è‡ªå®šä¹‰ç™»é™†ï¼Œå°†è‡ªå®šä¹‰ç™»é™†æ€tokenè¿”å›ç»™å°ç¨‹åºä½œä¸ºç™»é™†å‡­è¯ã€‚ç”¨æˆ·çš„ä¿¡æ¯ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œç™»é™†æ€tokenç¼“å­˜åœ¨redisä¸­ã€‚æ¶‰åŠçš„æŠ€æœ¯æ ˆï¼š</p>
<ul>
<li>SpringBoot -&gt; åç«¯åŸºç¡€ç¯å¢ƒ</li>
<li>Shiro -&gt; å®‰å…¨æ¡†æ¶</li>
<li>JWT -&gt; åŠ å¯†token</li>
<li>MySQL -&gt; ä¸»åº“ï¼Œå­˜å‚¨ä¸šåŠ¡æ•°æ®</li>
<li>MyBatis-Plus -&gt; æ“ä½œæ•°æ®åº“</li>
<li>Redis -&gt; ç¼“å­˜tokenå’Œå…¶ä»–çƒ­ç‚¹æ•°æ®</li>
<li>Lombok -&gt; ç®€åŒ–å¼€å‘</li>
<li>FastJson -&gt; jsonæ¶ˆæ¯å¤„ç†</li>
<li>RestTemplate -&gt; ä¼˜é›…çš„å¤„ç†webè¯·æ±‚</li>
</ul>
<p>é¡¹ç›®GitHubåœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/gongsir0630/shiro-jwt-demo">https://github.com/gongsir0630/shiro-jwt-demo</a></p>
<h2 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h2><ul>
<li>åŸºäºWxJavaå¯¹æ¥å¾®ä¿¡å°ç¨‹åºï¼Œå®ç°ç”¨æˆ·ç™»å½•ã€æ¶ˆæ¯å¤„ç†</li>
<li>æ”¯æŒShiroæ³¨è§£ç¼–ç¨‹ï¼Œä¿æŒé«˜åº¦çš„çµæ´»æ€§</li>
<li>ä½¿ç”¨JWTè¿›è¡Œæ ¡éªŒï¼Œå®Œå…¨å®ç°æ— çŠ¶æ€é‰´æƒ</li>
<li>ä½¿ç”¨Rediså­˜å‚¨è‡ªå®šä¹‰ç™»é™†æ€tokenï¼Œæ”¯æŒè¿‡æœŸæ—¶é—´</li>
<li>æ”¯æŒè·¨åŸŸè¯·æ±‚</li>
</ul>
<h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p><strong>åŸºç¡€çŸ¥è¯†é¢„å¤‡ï¼š</strong></p>
<ul>
<li>å…·å¤‡SpringBootåŸºç¡€çŸ¥è¯†å¹¶ä¸”ä¼šä½¿ç”¨åŸºæœ¬æ³¨è§£ï¼›</li>
<li>äº†è§£JWTï¼ˆJson Web Tokenï¼‰çš„åŸºæœ¬æ¦‚å¿µï¼Œå¹¶ä¸”ä¼šç®€å•æ“ä½œJWTçš„ <a target="_blank" rel="noopener" href="https://github.com/auth0/java-jwt">JAVA SDK</a>ï¼›</li>
<li>äº†è§£Shiroçš„åŸºæœ¬æ¦‚å¿µï¼šSubjectã€Realmã€SecurityManagerç­‰ï¼ˆå»ºè®®å»å®˜ç½‘å­¦ä¹ ä¸€ä¸‹ï¼‰</li>
</ul>
<p><strong>å…¶ä»–è¯´æ˜ï¼š</strong></p>
<p>æœ¬æ–‡åªå¯¹shiroå’Œjwtæ•´åˆè¿›è¡Œä»‹ç»è¯´æ˜ï¼Œå…·ä½“çš„å¾®ä¿¡ç™»å½•å®ç°æ˜¯ä½¿ç”¨<code>RestTemplate</code>è°ƒç”¨æˆ‘è‡ªå·±çš„<code>wx-java-miniapp</code>é¡¹ç›®ï¼Œè¯¥é¡¹ç›®åŸºäº<code>WxJava</code>å®ç°ï¼Œæ”¯æŒå¤šä¸ªå°ç¨‹åºç™»å½•ã€æ¶ˆæ¯å¤„ç†ã€‚</p>
<p><strong>æœ¬æ–‡ä½¿ç”¨ä»¥ä¸‹è°ƒç”¨å¤„ç†å³å¯ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. todo: å¾®ä¿¡ç™»å½•: code + appid -&gt; openId + session_key</span></span><br><span class="line"><span class="comment">// appid: ä»é…ç½®æ–‡ä»¶è¯»å–</span></span><br><span class="line">MultiValueMap&lt;String, Object&gt; request = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line"><span class="comment">// å‚æ•°å°è£…, å¾®ä¿¡ç™»å½•éœ€è¦ä»¥ä¸‹å‚æ•°</span></span><br><span class="line">request.add(<span class="string">&quot;code&quot;</span>, code);</span><br><span class="line"><span class="comment">// eg: http://localhost:8081/wx/user/&#123;appid&#125;/login</span></span><br><span class="line"><span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> url+<span class="string">&quot;/user/&quot;</span>+appid+<span class="string">&quot;/login&quot;</span>;</span><br><span class="line"><span class="comment">// è¯·æ±‚</span></span><br><span class="line"><span class="type">JSONObject</span> <span class="variable">dto</span> <span class="operator">=</span> restTemplate.postForObject(path, request, JSONObject.class);</span><br><span class="line">log.info(<span class="string">&quot;---&gt;&gt;&gt;æ¥è‡ª[&#123;&#125;]çš„è¿”å› = [&#123;&#125;]&quot;</span>,path,dto);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. todo: ä½¿ç”¨openIdå’Œsession_keyç”Ÿæˆè‡ªå®šä¹‰ç™»å½•çŠ¶æ€ -&gt; token</span></span><br></pre></td></tr></table></figure>
<p><strong>é¡¹ç›®åœ°å€ï¼š</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/gongsir0630/wx-java-miniapp">wx-java-miniapp -&gt; å¯ä»¥ç›´æ¥éƒ¨ç½²ä½¿ç”¨</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Wechat-Group/WxJava">WxJava -&gt; å®˜æ–¹SDK</a></li>
</ul>
<h2 id="æ•´ä½“æ€è·¯"><a href="#æ•´ä½“æ€è·¯" class="headerlink" title="æ•´ä½“æ€è·¯"></a>æ•´ä½“æ€è·¯</h2><p>å…ˆäº†è§£ä¸€ä¸‹å°ç¨‹åºå®˜æ–¹ç™»å½•æµç¨‹ï¼Œ<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html">å®˜æ–¹è¯´æ˜æˆ³è¿™é‡Œ</a></p>
<p><img src= "/blog/img/loading.gif" data-src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3c7b2c5fa55c46fbbd41976635b20807~tplv-k3u1fbpfcp-watermark.image" alt="å°ç¨‹åºç™»å½•æµç¨‹"></p>
<ol>
<li>å°ç¨‹åºè°ƒç”¨<code>wx.login()</code>å¾—åˆ°<code>code</code>ï¼Œå°†codeå‘é€åˆ°åå°ï¼Œåå°é€šè¿‡<code>wx-java-miniapp</code>è·å–åˆ°ç”¨æˆ·çš„<code>openId</code>å’Œ<code>session_key</code>ï¼›</li>
<li>åå°é€šè¿‡jwtå·¥å…·ç”Ÿæˆè‡ªå®šä¹‰ç”¨æˆ·çŠ¶æ€ä¿¡æ¯<code>token</code>ï¼Œå¹¶ä¸”åå°åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢<code>openId</code>åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œæ ¹æ®æŸ¥è¯¢ç»“æœå°è£…ä¸åŒçš„æ¶ˆæ¯ï¼Œæœ€åè¿åŒ<code>token</code>ä¸€èµ·è¿”å›ç»™å°ç¨‹åºï¼›</li>
<li>ä¹‹åç”¨æˆ·è®¿é—®æ¯ä¸€ä¸ªéœ€è¦æƒé™çš„APIè¯·æ±‚å¿…é¡»åœ¨<code>header</code>ä¸­æ·»åŠ <code>Authorization</code>å­—æ®µï¼Œåå°ä¼šè¿›è¡Œ<code>token</code>çš„æ ¡éªŒï¼Œå¦‚æœæœ‰è¯¯ä¼šç›´æ¥è¿”å›<code>401</code>ã€‚</li>
</ol>
<h2 id="tokenåŠ å¯†è¯´æ˜"><a href="#tokenåŠ å¯†è¯´æ˜" class="headerlink" title="tokenåŠ å¯†è¯´æ˜"></a>tokenåŠ å¯†è¯´æ˜</h2><ul>
<li>ä½¿ç”¨<code>uuid</code>éšæœºç”Ÿæˆä¸€ä¸ªjwt-id</li>
<li>å°†ç”¨æˆ·çš„<code>openId</code>ã€<code>session_key</code>è¿åŒ<code>jwt-id</code>ä¸€èµ·ï¼Œä½¿ç”¨å°ç¨‹åºçš„<code>appid</code>è¿›è¡Œç­¾ååŠ å¯†å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæœ€ç»ˆç”Ÿæˆ<code>token</code></li>
<li>å°†<code>&quot;JWT-SESSION-&quot;+jwt-id</code>å’Œ<code>token</code>ä»¥key-valueçš„å½¢å¼å­˜å…¥<code>redis</code>ä¸­ï¼Œå¹¶è®¾ç½®ç›¸åŒçš„è¿‡æœŸæ—¶é—´</li>
</ul>
<h2 id="tokenæ ¡éªŒè¯´æ˜"><a href="#tokenæ ¡éªŒè¯´æ˜" class="headerlink" title="tokenæ ¡éªŒè¯´æ˜"></a>tokenæ ¡éªŒè¯´æ˜</h2><ul>
<li>è§£ætokenä¸­jwt-id</li>
<li>ä»¥<code>&quot;JWT-SESSION-&quot;+jwt-id</code>ä¸ºkeyä»redisä¸­è·å–redisToken</li>
<li>è§£æ<code>redisToken</code>çš„æºå¸¦ä¿¡æ¯ï¼Œé‡æ–°ä»¥ç›¸åŒçš„æ–¹å¼ç”ŸæˆéªŒè¯å™¨ï¼ŒåŒ<code>token</code>è¿›è¡Œæ ¡éªŒæ¯”å¯¹</li>
</ul>
<h2 id="é¡¹ç›®å®ç°"><a href="#é¡¹ç›®å®ç°" class="headerlink" title="é¡¹ç›®å®ç°"></a>é¡¹ç›®å®ç°</h2><ul>
<li>é¡¹ç›®æ•°æ®åº“ä½¿ç”¨<code>MySQL</code>ä½œä¸ºä½œä¸ºä¸»åº“ï¼Œå¦‚æœæ˜¯<code>clone</code>çš„é¡¹ç›®ï¼Œè¯·åœ¨è¿è¡Œä¹‹å‰å‡†å¤‡å¥½ç›¸åº”çš„æ•°æ®åº“ï¼Œå¹¶ä¿®æ”¹é…ç½®ä¿¡æ¯ã€‚</li>
<li>é¡¹ç›®ä½¿ç”¨äº†redisç¼“å­˜ï¼Œè¿è¡Œå‰è¯·åœ¨æœ¬åœ°å®‰è£…<code>redis</code>ï¼Œä½¿ç”¨é»˜è®¤é…ç½®å³å¯ï¼Œæ— éœ€ä¿®æ”¹ã€‚</li>
<li>é¡¹ç›®ä¸­ä½¿ç”¨äº†<code>lombok</code>ç®€åŒ–å¼€å‘ï¼Œè¯·åœ¨ideaæˆ–è€…eclipseå®‰è£…lombokæ’ä»¶ã€‚</li>
</ul>
<h3 id="åˆ›å»ºMavené¡¹ç›®"><a href="#åˆ›å»ºMavené¡¹ç›®" class="headerlink" title="åˆ›å»ºMavené¡¹ç›®"></a>åˆ›å»ºMavené¡¹ç›®</h3><p>æ–°å»ºä¸€ä¸ªSpringBooté¡¹ç›®ï¼Œä¿®æ”¹pomæ–‡ä»¶ï¼Œæ·»åŠ ç›¸å…³dependency:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.gongsir0630<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-jwt-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>shiro-jwt-demo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.3.7.RELEASE<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- shiro: ç”¨æˆ·è®¤è¯\æ¥å£é‰´æƒ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- jwt: tokenè®¤è¯ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.auth0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>java-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- redis: æ•°æ®ç¼“å­˜ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- å¼•å…¥fastjson --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- druidæ•°æ®åº“è¿æ¥æ±  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- mybatis-plus: æ“ä½œæ•°æ®åº“ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- mysqlé©±åŠ¨--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- å·¥å…·: ç®€åŒ–modelå¼€å‘ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- å•å…ƒæµ‹è¯•å·¥å…· --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.github.gongsir0630.shirodemo.ShiroJwtDemoApplication<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„JDKç‰ˆæœ¬ï¼š1.8</p>
</blockquote>
<h3 id="ç›¸å…³é…ç½®-å·¥å…·å‡†å¤‡"><a href="#ç›¸å…³é…ç½®-å·¥å…·å‡†å¤‡" class="headerlink" title="ç›¸å…³é…ç½® | å·¥å…·å‡†å¤‡"></a>ç›¸å…³é…ç½® | å·¥å…·å‡†å¤‡</h3><p>é…ç½®ä½ çš„application.yml ï¼Œä¸»è¦æ˜¯é…ç½®ä½ çš„å°ç¨‹åºappidå’Œurlï¼Œè¿˜æœ‰ä½ çš„æ•°æ®åº“å’Œredisã€‚</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®æ—¥å¿—çº§åˆ«</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">    <span class="attr">level:</span></span><br><span class="line">        <span class="attr">org.springframework.web:</span> <span class="string">info</span></span><br><span class="line">        <span class="attr">com.github.gongsir0630.shirodemo:</span> <span class="string">debug</span></span><br><span class="line"><span class="comment"># devç¯å¢ƒé…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="comment"># æ•°æ®åº“ç›¸å…³é…ç½®ä¿¡æ¯: æ— éœ€å†æœ¬åœ°å®‰è£…mysql,ä½¿ç”¨yzhelp.topäº‘ç«¯æ•°æ®åº“</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/shiro-jwt-demo</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">username</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">password</span></span><br><span class="line">    <span class="comment"># redis é…ç½®ä¿¡æ¯: åœ¨æœ¬åœ°å®‰è£…redis</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">        <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># æœåŠ¡å¯åŠ¨çš„ç«¯å£å·</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># å¾®ä¿¡å°ç¨‹åºé…ç½® appid / url</span></span><br><span class="line"><span class="attr">wx:</span></span><br><span class="line">    <span class="comment"># å°ç¨‹åºAppId</span></span><br><span class="line">    <span class="attr">appid:</span> <span class="string">appid</span></span><br><span class="line">    <span class="comment"># è‡ªç ”å°ç¨‹åºæ¥å£è°ƒç”¨åœ°å€</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">http://localhost:8081/wx</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¯´æ˜ï¼š<br/>appid: å½“å‰å°ç¨‹åºçš„appid<br/>url: wx-java-miniappé¡¹ç›®æ¥å£åœ°å€</p>
</blockquote>
<h4 id="é…ç½®fastJson"><a href="#é…ç½®fastJson" class="headerlink" title="é…ç½®fastJson"></a>é…ç½®fastJson</h4><p>åœ¨å¯åŠ¨ç±»ä¸­é…ç½®<code>fastJson</code> -&gt; <strong>ShiroJwtDemoApplication.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gongsir &lt;a href=&quot;https://github.com/gongsir0630&quot;&gt;ç¨‹åºå‘˜Kyleâœ¨&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> * æè¿°: Spring Boot å·¥ç¨‹å¯åŠ¨ç±»,å¯ä»¥ç›´æ¥ç‚¹å‡»ä¸‹é¢çš„mainæ–¹æ³•è¿è¡Œç¨‹åº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroJwtDemoApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ShiroJwtDemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * fastjson é…ç½®æ³¨å…¥: ä½¿ç”¨é˜¿é‡Œå·´å·´çš„ fastjson å¤„ç† json ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> HttpMessageConverters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HttpMessageConverters <span class="title function_">fastJsonHttpMessageConverters</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ¶ˆæ¯è½¬æ¢å¯¹è±¡</span></span><br><span class="line">        <span class="type">FastJsonHttpMessageConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FastJsonHttpMessageConverter</span>();</span><br><span class="line">        <span class="comment">// fastjson é…ç½®</span></span><br><span class="line">        <span class="type">FastJsonConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FastJsonConfig</span>();</span><br><span class="line">        config.setSerializerFeatures(SerializerFeature.PrettyFormat);</span><br><span class="line">        config.setDateFormat(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">        <span class="comment">// é…ç½®æ³¨å…¥æ¶ˆæ¯è½¬æ¢å™¨</span></span><br><span class="line">        converter.setFastJsonConfig(config);</span><br><span class="line">        <span class="comment">// è®© spring ä½¿ç”¨è‡ªå®šä¹‰çš„æ¶ˆæ¯è½¬æ¢å™¨</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpMessageConverters</span>(converter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="é…ç½®Redis"><a href="#é…ç½®Redis" class="headerlink" title="é…ç½®Redis"></a>é…ç½®Redis</h4><p>é…ç½®Redis -&gt; <strong>RedisConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/20 14:15</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: Redisé…ç½®</span></span><br><span class="line"><span class="comment"> * EnableCaching: å¼€å¯ç¼“å­˜</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CacheManager <span class="title function_">cacheManager</span><span class="params">(RedisConnectionFactory factory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RedisCacheManager.create(factory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="é…ç½®RestTemplate"><a href="#é…ç½®RestTemplate" class="headerlink" title="é…ç½®RestTemplate"></a>é…ç½®RestTemplate</h4><p>é…ç½®RestTemplate -&gt; <strong>RestTemplateConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/20 14:10</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: RestTemplateçš„é…ç½®ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestTemplateConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">(ClientHttpRequestFactory factory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>(factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ClientHttpRequestFactory <span class="title function_">simpleClientHttpRequestFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SimpleClientHttpRequestFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleClientHttpRequestFactory</span>();</span><br><span class="line">        <span class="comment">// è¿æ¥è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º10ç§’</span></span><br><span class="line">        factory.setConnectTimeout(<span class="number">1000</span> * <span class="number">10</span>);</span><br><span class="line">        <span class="comment">// è¯»å–è¶…æ—¶æ—¶é—´ä¸ºå•ä½ä¸º60ç§’</span></span><br><span class="line">        factory.setReadTimeout(<span class="number">1000</span> * <span class="number">60</span>);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è¿”å›é›†å°è£…"><a href="#è¿”å›é›†å°è£…" class="headerlink" title="è¿”å›é›†å°è£…"></a>è¿”å›é›†å°è£…</h4><p><strong>CodeMsg.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/22 20:17</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: codeå’Œmsgå°è£…</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CodeMsg</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String msg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CodeMsg SUCCESS=<span class="keyword">new</span> <span class="title class_">CodeMsg</span>(<span class="number">0</span>,<span class="string">&quot;success&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">CodeMsg</span> <span class="variable">LOGIN_FAIL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CodeMsg</span>(-<span class="number">1</span>,<span class="string">&quot;code2session failure, please try aging&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">CodeMsg</span> <span class="variable">NO_USER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CodeMsg</span>(<span class="number">1000</span>,<span class="string">&quot;user not found&quot;</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">CodeMsg</span> <span class="variable">SESSION_KEY_ERROR</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CodeMsg</span>(<span class="number">1001</span>,<span class="string">&quot;sessionKey is invalid&quot;</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">CodeMsg</span> <span class="variable">TOKEN_ERROR</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CodeMsg</span>(<span class="number">1002</span>,<span class="string">&quot;token is invalid&quot;</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">CodeMsg</span> <span class="variable">SHIRO_ERROR</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CodeMsg</span>(<span class="number">1003</span>,<span class="string">&quot;token is invalid&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CodeMsg</span><span class="params">(<span class="type">int</span> code, String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code=code;</span><br><span class="line">        <span class="built_in">this</span>.msg=msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;CodeMsg&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;code=&quot;</span> + code +</span><br><span class="line">                <span class="string">&quot;, msg=&#x27;&quot;</span> + msg + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Result.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/20 18:45</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°:</span></span><br><span class="line"><span class="comment"> * è¾“å‡ºç»“æœçš„å°è£…</span></span><br><span class="line"><span class="comment"> * åªè¦getä¸è¦set,è¿›è¡Œæ›´å¥½çš„å°è£…</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; dataæ³›å‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Result</span><span class="params">(T data)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.code=<span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.msg=<span class="string">&quot;success&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.data=data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Result</span><span class="params">(CodeMsg mg, T data)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mg==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.code=mg.getCode();</span><br><span class="line">        <span class="built_in">this</span>.msg=mg.getMsg();</span><br><span class="line">        <span class="built_in">this</span>.data=data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æˆåŠŸæ—¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; dataæ³›å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt;  Result&lt;T&gt;  <span class="title function_">success</span><span class="params">(T data)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;T&gt;(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤±è´¥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; dataæ³›å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt;  Result&lt;T&gt;  <span class="title function_">fail</span><span class="params">(CodeMsg mg, T data)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>&lt;T&gt;(mg,data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å¼‚å¸¸å°è£…ä¸å¤„ç†"><a href="#å¼‚å¸¸å°è£…ä¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å°è£…ä¸å¤„ç†"></a>å¼‚å¸¸å°è£…ä¸å¤„ç†</h4><p>è‡ªå®šä¹‰å¼‚å¸¸ -&gt; <strong>ApiAuthException.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.controller.res.CodeMsg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/22 20:24</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: è‡ªå®šä¹‰å¼‚å¸¸, ç”¨äºå¤„ç†Apiè®¤è¯å¤±è´¥å¼‚å¸¸ä¿¡æ¯ä¿å­˜</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiAuthException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> CodeMsg codeMsg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ApiAuthException</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ApiAuthException</span><span class="params">(CodeMsg codeMsg)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(codeMsg.getMsg());</span><br><span class="line">        <span class="built_in">this</span>.codeMsg = codeMsg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CodeMsg <span class="title function_">getCodeMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> codeMsg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCodeMsg</span><span class="params">(CodeMsg codeMsg)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.codeMsg = codeMsg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¨å±€å¼‚å¸¸å¤„ç† -&gt; <strong>AppExceptionHandler.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/20 15:49</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: å…¨å±€å¼‚å¸¸å¤„ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç† Shiro å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e å¼‚å¸¸ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> json</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(&#123;ShiroException.class&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.UNAUTHORIZED)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Result&lt;JSONObject&gt;&gt; <span class="title function_">handShiroException</span><span class="params">(ShiroException e)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;---&gt;&gt;&gt; æ•æ‰åˆ° [ApiAuthException] å¼‚å¸¸: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(Result.fail(CodeMsg.SHIRO_ERROR,<span class="literal">null</span>), HttpStatus.UNAUTHORIZED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç† è‡ªå®šä¹‰ApiAuthExceptionå¼‚å¸¸</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e å¼‚å¸¸ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> json</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(&#123;ApiAuthException.class&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.UNAUTHORIZED)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Result&lt;JSONObject&gt;&gt; <span class="title function_">handApiAuthException</span><span class="params">(ApiAuthException e)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;---&gt;&gt;&gt; æ•æ‰åˆ° [ApiAuthException] å¼‚å¸¸: &#123;&#125;,&#123;&#125;&quot;</span>,e.getCodeMsg().getCode(),e.getCodeMsg().getMsg() );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(Result.fail(e.getCodeMsg(),<span class="literal">null</span>), HttpStatus.UNAUTHORIZED);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å‡†å¤‡æ•°æ®æº"><a href="#å‡†å¤‡æ•°æ®æº" class="headerlink" title="å‡†å¤‡æ•°æ®æº"></a>å‡†å¤‡æ•°æ®æº</h3><ul>
<li>æ•°æ®åº“ï¼šshiro-jwt-demo</li>
<li>æ•°æ®è¡¨ï¼šuser<br><img src= "/blog/img/loading.gif" data-src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b52785aad974131a859d2a51feaa0ca~tplv-k3u1fbpfcp-watermark.image" alt="ç¤ºä¾‹æ•°æ®åº“è¡¨ç»“æ„"></li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼šè¿™é‡Œæ˜¯ä¸šåŠ¡æ•°æ®åº“ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å°ç¨‹åºç”¨æˆ·ä¿¡æ¯éƒ½ç”±æˆ‘ä»¬è‡ªå·±å­˜å‚¨ï¼Œç¬¬ä¸€æ¬¡é»˜è®¤ä½¿ç”¨å¾®ä¿¡å…¬å¼€ä¿¡æ¯æ³¨å†Œï¼Œä¹‹åç”¨æˆ·å¯ä»¥è‡ªè¡Œæ›´æ–°è¿™äº›ä¿¡æ¯ï¼Œå’Œå¾®ä¿¡ä¿¡æ¯ç‹¬ç«‹å¼€ã€‚</p>
</blockquote>
<p>åˆ›å»ºå¯¹åº”çš„å®ä½“ç±» -&gt; <strong>User.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/21 23:44</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: ä¸šåŠ¡ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName(&quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸»é”®,æ•°æ®åº“å­—æ®µä¸ºuser_id -&gt; userId == openId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId(value = &quot;user_id&quot;,type = IdType.INPUT)</span></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String photo;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">    <span class="keyword">private</span> String grade;</span><br><span class="line">    <span class="keyword">private</span> String college;</span><br><span class="line">    <span class="keyword">private</span> String contact;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨MyBatis-plusåˆ›å»ºmapperæ¥å£ -&gt; <strong>UserMapper.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/22 19:44</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: Userç±»mapperæ¥å£,ç»§æ‰¿è‡ªBaseMapper(å·²ç»å®ç°Userçš„CRUD)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MyBatis-Plusé…ç½® -&gt; <strong>MybatisPlusConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/19 17:15</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: MyBatis-Plusæ’ä»¶é…ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.github.gongsir0630.shirodemo.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºUserä¸šåŠ¡æ¥å£ï¼Œè¿™é‡Œä»…ä»…æ¼”ç¤ºlogin -&gt; <strong>UserService.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/22 19:49</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: ç”¨æˆ·æ¥å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç™»å½•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jsCode å°ç¨‹åºcode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ç™»å½•ä¿¡æ¯: åŒ…å«token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Map&lt;String, String&gt; <span class="title function_">login</span><span class="params">(String jsCode)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†åˆ›å»ºä¸€ä¸ªå¾®ä¿¡ç™»å½•ä¿¡æ¯å¯¹è±¡ï¼Œä¸»è¦ç”¨ä½œæ¥æ”¶å¾®ä¿¡çš„openidå’Œsession_keyï¼Œä»¥åŠç”¨ä½œshiroè®¤è¯ -&gt; <strong>WxAccount.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> * <span class="meta">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https:<span class="comment">//github.com/gongsir0630</span></span><br><span class="line"> * <span class="meta">@date</span> <span class="number">2021</span>/<span class="number">3</span>/<span class="number">22</span> <span class="number">19</span>:<span class="number">58</span></span><br><span class="line"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span><br><span class="line"> * æè¿°: å¾®ä¿¡è®¤è¯ä¿¡æ¯</span><br><span class="line"> */</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxAccount</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String openId;</span><br><span class="line">    <span class="keyword">private</span> String sessionKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„ï¼šè¯¥ç±»ä¸ä¼šç”¨äºä¸šåŠ¡ä¿¡æ¯äº¤äº’ï¼Œæ‰€ä»¥ä¸éœ€è¦Mapperä¸dbäº¤äº’ã€‚</p>
</blockquote>
<p>å¾®ä¿¡ç™»å½•æ¥å£ï¼Œåœ¨è¿™é‡Œå®ç°ä¸å¾®ä¿¡æœåŠ¡å™¨çš„ä¿¡æ¯äº¤äº’ -&gt; <strong>WxAccountService.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> * <span class="meta">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https:<span class="comment">//github.com/gongsir0630</span></span><br><span class="line"> * <span class="meta">@date</span> <span class="number">2021</span>/<span class="number">3</span>/<span class="number">22</span> <span class="number">20</span>:<span class="number">06</span></span><br><span class="line"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span><br><span class="line"> * æè¿°: å¾®ä¿¡æ¥å£</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WxAccountService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¾®ä¿¡å°ç¨‹åºç”¨æˆ·ç™»é™†ï¼Œå®Œæ•´æµç¨‹å¯å‚è€ƒä¸‹é¢å®˜æ–¹åœ°å€ï¼Œæœ¬ä¾‹ä¸­æ˜¯æŒ‰æ­¤æµç¨‹å¼€å‘</span></span><br><span class="line"><span class="comment">     * https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html</span></span><br><span class="line"><span class="comment">     * 1 . å¾®ä¿¡å°ç¨‹åºç«¯ä¼ å…¥codeã€‚</span></span><br><span class="line"><span class="comment">     * 2 . é€šè¿‡wx-java-miniappé¡¹ç›®è°ƒç”¨å¾®ä¿¡code2sessionæ¥å£è·å–openidå’Œsession_key</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code å°ç¨‹åºç«¯ è°ƒç”¨ wx.login è·å–åˆ°çš„code,ç”¨äºè°ƒç”¨ å¾®ä¿¡code2sessionæ¥å£</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> JSONObject: åŒ…å«openIdå’ŒsessionKey</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    WxAccount <span class="title function_">login</span><span class="params">(String code)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥å£å®ç°é€»è¾‘ï¼š</p>
<ol>
<li>ä»é…ç½®æ–‡ä»¶è¯»å–<code>appid</code>å’Œ<code>url</code>ï¼›</li>
<li>å‡­å€Ÿç›®æ ‡è¯·æ±‚åœ°å€<code>path</code>ï¼Œä¾‹å¦‚ç™»å½•æ˜¯ <code>&#123;url&#125;/wx/user/&#123;appid&#125;/login</code>ï¼›</li>
<li>å‚æ•°å°è£…ï¼Œå°è£…æ¥è‡ªå°ç¨‹åºçš„<code>code</code>ï¼›</li>
<li>ä½¿ç”¨<code>RestTemplate</code>å‘èµ·ç™»å½•è¯·æ±‚ï¼›</li>
<li>å¤„ç†è¿”å›é›†ã€‚</li>
</ol>
<p>ä»£ç å®ç° -&gt; <strong>WxAccountServiceImpl.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/20 16:12</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: å¾®ä¿¡æ¥å£å®ç°: ç”¨ restTemplate è°ƒç”¨ [wxApp] åº”ç”¨çš„æ¥å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxAccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">WxAccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;wx.appid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appid;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;wx.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> WxAccount <span class="title function_">login</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="comment">// todo: å¾®ä¿¡ç™»å½•: code + appid -&gt; openId + session_key</span></span><br><span class="line">        <span class="comment">// appid: ä»é…ç½®æ–‡ä»¶è¯»å–</span></span><br><span class="line">        MultiValueMap&lt;String, Object&gt; request = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// å‚æ•°å°è£…, å¾®ä¿¡ç™»å½•éœ€è¦ä»¥ä¸‹å‚æ•°</span></span><br><span class="line">        request.add(<span class="string">&quot;code&quot;</span>, code);</span><br><span class="line">        <span class="comment">// eg: http://localhost:8081/wx/user/&#123;appid&#125;/login</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> url+<span class="string">&quot;/user/&quot;</span>+appid+<span class="string">&quot;/login&quot;</span>;</span><br><span class="line">        <span class="comment">// è¯·æ±‚</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">dto</span> <span class="operator">=</span> restTemplate.postForObject(path, request, JSONObject.class);</span><br><span class="line">        log.info(<span class="string">&quot;---&gt;&gt;&gt;æ¥è‡ª[&#123;&#125;]çš„è¿”å› = [&#123;&#125;]&quot;</span>,path,dto);</span><br><span class="line">        <span class="type">int</span> <span class="variable">errCode</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (dto != <span class="literal">null</span> ) &#123;</span><br><span class="line">            errCode = Integer.parseInt(dto.get(<span class="string">&quot;code&quot;</span>).toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApiAuthException</span>(CodeMsg.LOGIN_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != errCode) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApiAuthException</span>(<span class="keyword">new</span> <span class="title class_">CodeMsg</span>(Integer.parseInt(dto.get(<span class="string">&quot;code&quot;</span>).toString()),</span><br><span class="line">                dto.get(<span class="string">&quot;msg&quot;</span>).toString()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// code2session success</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">data</span> <span class="operator">=</span> dto.getJSONObject(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> JSON.toJavaObject(data, WxAccount.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ„å»ºJWT"><a href="#æ„å»ºJWT" class="headerlink" title="æ„å»ºJWT"></a>æ„å»ºJWT</h3><p>jwtå·¥å…·ç±»ï¼Œç”¨äºç”Ÿæˆtokenç­¾å, tokenæ ¡éªŒ -&gt; <strong>JwtUtil.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/23 10:26</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: jwtå·¥å…·ç±»: ç”Ÿæˆtokenç­¾å, tokenæ ¡éªŒ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;All&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtil</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿‡æœŸæ—¶é—´: 2å°æ—¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">EXPIRE_TIME</span> <span class="operator">=</span> <span class="number">7200</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä½¿ç”¨ appid ç­¾å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;wx.appid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appsecret;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®å¾®ä¿¡ç”¨æˆ·ç™»é™†ä¿¡æ¯åˆ›å»º token</span></span><br><span class="line"><span class="comment">     * ä½¿ç”¨`uuid`éšæœºç”Ÿæˆä¸€ä¸ªjwt-id</span></span><br><span class="line"><span class="comment">     * å°†ç”¨æˆ·çš„`openId`ã€`session_key`è¿åŒ`jwt-id`ä¸€èµ·ï¼Œä½¿ç”¨å°ç¨‹åºçš„`appid`è¿›è¡Œç­¾ååŠ å¯†å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæœ€ç»ˆç”Ÿæˆ`token`</span></span><br><span class="line"><span class="comment">     * å°†`&quot;JWT-SESSION-&quot;+jwt-id`å’Œ`token`ä»¥key-valueçš„å½¢å¼å­˜å…¥`redis`ä¸­ï¼Œå¹¶è®¾ç½®ç›¸åŒçš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     * æ³¨ : è¿™é‡Œçš„tokenä¼šè¢«ç¼“å­˜åˆ°redisä¸­,ç”¨ä½œä¸ºäºŒæ¬¡éªŒè¯</span></span><br><span class="line"><span class="comment">     * redisé‡Œé¢ç¼“å­˜çš„æ—¶é—´åº”è¯¥å’Œjwt tokençš„è¿‡æœŸæ—¶é—´è®¾ç½®ç›¸åŒ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> wxAccount å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å› jwt token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sign</span><span class="params">(WxAccount account)</span> &#123;</span><br><span class="line">        <span class="comment">//JWT éšæœºID,åšä¸ºrediséªŒè¯çš„key</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwtId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">//1 . åŠ å¯†ç®—æ³•è¿›è¡Œç­¾åå¾—åˆ°token</span></span><br><span class="line">        <span class="type">Algorithm</span> <span class="variable">algorithm</span> <span class="operator">=</span> Algorithm.HMAC256(appsecret);</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> JWT.create()</span><br><span class="line">                .withClaim(<span class="string">&quot;openId&quot;</span>, account.getOpenId())</span><br><span class="line">                .withClaim(<span class="string">&quot;sessionKey&quot;</span>, account.getSessionKey())</span><br><span class="line">                .withClaim(<span class="string">&quot;jwt-id&quot;</span>,jwtId)</span><br><span class="line">                .withExpiresAt(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + EXPIRE_TIME * <span class="number">1000</span>))</span><br><span class="line">                .sign(algorithm);</span><br><span class="line">        <span class="comment">//2 . Redisç¼“å­˜JWT, æ³¨ : è¯·å’ŒJWTè¿‡æœŸæ—¶é—´ä¸€è‡´</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;JWT-SESSION-&quot;</span>+jwtId, token, EXPIRE_TIME, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * token æ£€éªŒ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verify</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1 . æ ¹æ®tokenè§£å¯†ï¼Œè§£å¯†å‡ºjwt-id , å…ˆä»redisä¸­æŸ¥æ‰¾å‡ºredisTokenï¼ŒåŒ¹é…æ˜¯å¦ç›¸åŒ</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">redisToken</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;JWT-SESSION-&quot;</span> + getClaimsByToken(token).get(<span class="string">&quot;jwt-id&quot;</span>).asString());</span><br><span class="line">            <span class="keyword">if</span> (!token.equals(redisToken)) &#123;</span><br><span class="line">                <span class="keyword">return</span> Boolean.FALSE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//2 . å¾—åˆ°ç®—æ³•ç›¸åŒçš„JWTVerifier</span></span><br><span class="line">            <span class="type">Algorithm</span> <span class="variable">algorithm</span> <span class="operator">=</span> Algorithm.HMAC256(appsecret);</span><br><span class="line">            <span class="type">JWTVerifier</span> <span class="variable">verifier</span> <span class="operator">=</span> JWT.require(algorithm)</span><br><span class="line">                    .withClaim(<span class="string">&quot;openId&quot;</span>, getClaimsByToken(redisToken).get(<span class="string">&quot;openId&quot;</span>).asString())</span><br><span class="line">                    .withClaim(<span class="string">&quot;sessionKey&quot;</span>, getClaimsByToken(redisToken).get(<span class="string">&quot;sessionKey&quot;</span>).asString())</span><br><span class="line">                    .withClaim(<span class="string">&quot;jwt-id&quot;</span>,getClaimsByToken(redisToken).get(<span class="string">&quot;jwt-id&quot;</span>).asString())</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="comment">//3 . éªŒè¯token</span></span><br><span class="line">            verifier.verify(token);</span><br><span class="line">            <span class="comment">//4 . Redisç¼“å­˜JWTç»­æœŸ</span></span><br><span class="line">            redisTemplate.opsForValue().set(<span class="string">&quot;JWT-SESSION-&quot;</span> + getClaimsByToken(token).get(<span class="string">&quot;jwt-id&quot;</span>).asString(),</span><br><span class="line">                    redisToken,</span><br><span class="line">                    EXPIRE_TIME,</span><br><span class="line">                    TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">return</span> Boolean.TRUE;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//æ•æ‰åˆ°ä»»ä½•å¼‚å¸¸éƒ½è§†ä¸ºæ ¡éªŒå¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> Boolean.FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»tokenè§£å¯†ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> JWTDecodeException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Claim&gt; <span class="title function_">getClaimsByToken</span><span class="params">(String token)</span> <span class="keyword">throws</span> JWTDecodeException &#123;</span><br><span class="line">        <span class="keyword">return</span> JWT.decode(token).getClaims();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Realmé…ç½®"><a href="#Realmé…ç½®" class="headerlink" title="Realmé…ç½®"></a>Realmé…ç½®</h3><p>åˆ›å»ºJwtTokenï¼Œç”¨äºshiroé‰´æƒï¼Œéœ€è¦å®ç°<code>AuthenticationToken</code> -&gt; <strong>JwtToken.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/23 10:48</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: é‰´æƒç”¨çš„tokenï¼Œéœ€è¦å®ç° AuthenticationToken</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtToken</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationToken</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getPrincipal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getCredentials</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡ªå®šä¹‰Shiroçš„Realmé…ç½®ï¼Œéœ€è¦åœ¨Realmä¸­å®ç°æˆ‘ä»¬è‡ªå®šä¹‰çš„ç™»é™†åŠæˆæƒé€»è¾‘ -&gt; <strong>ShiroRealm.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.controller.res.CodeMsg;</span><br><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.exception.ApiAuthException;</span><br><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.wx.util.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.wx.vo.JwtToken;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.SimpleAuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.CredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.Realm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/23 15:28</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: Realm çš„ä¸€ä¸ªé…ç½®ç®¡ç†ç±» allRealm()æ–¹æ³•å¾—åˆ°æ‰€æœ‰çš„realm</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroRealm</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JwtUtil jwtUtil;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°è£…æ‰€æœ‰è‡ªå®šä¹‰çš„realmè§„åˆ™é“¾ -&gt; shiroé…ç½®ä¸­ä¼šå°†è§„åˆ™æ³¨å…¥åˆ°shiroçš„securityManager</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ‰€æœ‰è‡ªå®šä¹‰çš„realmè§„åˆ™</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Realm&gt; <span class="title function_">allRealm</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Realm&gt; realmList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        realmList.add(authorizingRealm());</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableList(realmList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰ JWTçš„ Realm</span></span><br><span class="line"><span class="comment">     * é‡å†™ Realm çš„ supports() æ–¹æ³•æ˜¯é€šè¿‡ JWT è¿›è¡Œç™»å½•åˆ¤æ–­çš„å…³é”®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> AuthorizingRealm <span class="title function_">authorizingRealm</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AuthorizingRealm</span> <span class="variable">realm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthorizingRealm</span>() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å½“éœ€è¦æ£€æµ‹ ç”¨æˆ·æƒé™ æ—¶è°ƒç”¨æ­¤æ–¹æ³•ï¼Œä¾‹å¦‚checkRole,checkPermissionä¹‹ç±»çš„</span></span><br><span class="line"><span class="comment">             * æ ¹æ®ä¸šåŠ¡éœ€æ±‚è‡ªè¡Œç¼–å†™éªŒè¯é€»è¾‘</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> principalCollection == token</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> AuthorizationInfo <span class="title function_">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> principalCollection.toString();</span><br><span class="line">                log.info(<span class="string">&quot;---&gt;&gt;&gt;PrincipalCollection: [&#123;&#125;]&quot;</span>,token);</span><br><span class="line">                <span class="comment">// todo: è‡ªå®šä¹‰æƒé™éªŒè¯, æ¯”å¦‚roleå’ŒpermissionéªŒè¯</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthorizationInfo</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * é»˜è®¤ä½¿ç”¨æ­¤æ–¹æ³•è¿›è¡Œç”¨æˆ·åæ­£ç¡®ä¸å¦æ ¡éªŒ: éªŒè¯tokené€»è¾‘</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> (String) authenticationToken.getCredentials();</span><br><span class="line">                <span class="type">String</span> <span class="variable">openId</span> <span class="operator">=</span> jwtUtil.getClaimsByToken(jwtToken).get(<span class="string">&quot;openId&quot;</span>).asString();</span><br><span class="line">                <span class="type">String</span> <span class="variable">sessionKey</span> <span class="operator">=</span> jwtUtil.getClaimsByToken(jwtToken).get(<span class="string">&quot;sessionKey&quot;</span>).asString();</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == openId || <span class="string">&quot;&quot;</span>.equals(openId)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApiAuthException</span>(CodeMsg.NO_USER);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == sessionKey || <span class="string">&quot;&quot;</span>.equals(sessionKey)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApiAuthException</span>(CodeMsg.SESSION_KEY_ERROR);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!jwtUtil.verify(jwtToken)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApiAuthException</span>(CodeMsg.TOKEN_ERROR);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å°† openId å’Œ sessionKey è£…é…åˆ°subjectä¸­</span></span><br><span class="line">                <span class="comment">// åœ¨ Controller ä¸­ä½¿ç”¨ SecurityUtils.getSubject().getPrincipal() å³å¯è·å–ç”¨æˆ·openId</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(openId,sessionKey,<span class="built_in">this</span>.getClass().getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ³¨æ„å‘ç‚¹ : å¿…é¡»é‡å†™æ­¤æ–¹æ³•ï¼Œä¸ç„¶Shiroä¼šæŠ¥é”™</span></span><br><span class="line"><span class="comment">             * å› ä¸ºåˆ›å»ºäº† JWTToken ç”¨äºæ›¿æ¢ShiroåŸç”Ÿ token,æ‰€ä»¥å¿…é¡»åœ¨æ­¤æ–¹æ³•ä¸­æ˜¾å¼çš„è¿›è¡Œæ›¿æ¢ï¼Œå¦åˆ™åœ¨è¿›è¡Œåˆ¤æ–­æ—¶ä¼šä¸€ç›´å¤±è´¥</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(AuthenticationToken token)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> token <span class="keyword">instanceof</span> JwtToken;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        realm.setCredentialsMatcher(credentialsMatcher());</span><br><span class="line">        <span class="keyword">return</span> realm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³¨æ„ : å¯†ç æ ¡éªŒ, è¿™é‡Œå› ä¸ºæ˜¯JWTå½¢å¼,å°±æ— éœ€å¯†ç æ ¡éªŒå’ŒåŠ å¯†,ç›´æ¥è®©å…¶è¿”å›ä¸ºtrue(å¦‚æœä¸è®¾ç½®çš„è¯,è¯¥å€¼é»˜è®¤ä¸ºfalse,å³å§‹ç»ˆéªŒè¯ä¸é€šè¿‡)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> CredentialsMatcher <span class="title function_">credentialsMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å®ç°boolean doCredentialsMatch(AuthenticationToken var1, AuthenticationInfo var2);</span></span><br><span class="line">        <span class="keyword">return</span> (authenticationToken, authenticationInfo) -&gt; <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="é‡å†™filter"><a href="#é‡å†™filter" class="headerlink" title="é‡å†™filter"></a>é‡å†™filter</h3><p>æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šå…ˆç»è¿‡<code>Filter</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§æ‰¿å®˜æ–¹çš„<code>BasicHttpAuthenticationFilter</code>ï¼Œå¹¶ä¸”é‡å†™æ–¹æ³•å³å¯ -&gt; <strong>JwtFilter.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.wx.vo.JwtToken;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/23 10:58</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: JWTæ ¸å¿ƒè¿‡æ»¤å™¨é…ç½®</span></span><br><span class="line"><span class="comment"> * æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šå…ˆç»è¿‡Filterï¼Œç»§æ‰¿å®˜æ–¹çš„BasicHttpAuthenticationFilterï¼Œå¹¶ä¸”é‡å†™é‰´æƒçš„æ–¹æ³•</span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œæµç¨‹ preHandle-&gt;isAccessAllowed-&gt;isLoginAttempt-&gt;executeLogin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtFilter</span> <span class="keyword">extends</span> <span class="title class_">BasicHttpAuthenticationFilter</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·¨åŸŸæ”¯æŒ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request è¯·æ±‚</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response ç›¸åº”</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">httpServletRequest</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">httpServletResponse</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">        httpServletResponse.setHeader(<span class="string">&quot;Access-control-Allow-Origin&quot;</span>, httpServletRequest.getHeader(<span class="string">&quot;Origin&quot;</span>));</span><br><span class="line">        httpServletResponse.setHeader(<span class="string">&quot;Access-Control-Allow-Methods&quot;</span>, <span class="string">&quot;GET,POST,OPTIONS,PUT,DELETE&quot;</span>);</span><br><span class="line">        httpServletResponse.setHeader(<span class="string">&quot;Access-Control-Allow-Headers&quot;</span>, httpServletRequest.getHeader(<span class="string">&quot;Access-Control-Request-Headers&quot;</span>));</span><br><span class="line">        <span class="comment">// è·¨åŸŸæ—¶ä¼šé¦–å…ˆå‘é€ä¸€ä¸ªoptionè¯·æ±‚ï¼Œè¿™é‡Œæˆ‘ä»¬ç»™optionè¯·æ±‚ç›´æ¥è¿”å›æ­£å¸¸çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (httpServletRequest.getMethod().equals(RequestMethod.OPTIONS.name())) &#123;</span><br><span class="line">            httpServletResponse.setStatus(HttpStatus.OK.value());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.preHandle(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isLoginAttempt</span><span class="params">(ServletRequest request, ServletResponse response)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­requestæ˜¯å¦åŒ…å« Authorization å­—æ®µ</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">auth</span> <span class="operator">=</span> getAuthzHeader(request);</span><br><span class="line">        <span class="keyword">return</span> auth != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(auth);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isLoginAttempt(request,response)) &#123;</span><br><span class="line">            <span class="comment">// executeLogin è¿›å…¥ç™»å½•é€»è¾‘</span></span><br><span class="line">            <span class="comment">// ä»requestè¯·æ±‚å¤´è·å– Authorization å­—æ®µ</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> getAuthzHeader(request);</span><br><span class="line">            log.info(<span class="string">&quot;---&gt;&gt;&gt;JwtFilter::isAccessAllowedæ‹¦æˆªåˆ°è®¤è¯tokenä¿¡æ¯:[&#123;&#125;]&quot;</span>,token);</span><br><span class="line">            <span class="comment">// è¿™é‡Œä¼šæäº¤ç»™åˆšåˆšæˆ‘ä»¬è‡ªå®šä¹‰çš„realmå¤„ç†</span></span><br><span class="line">            getSubject(request,response).login(<span class="keyword">new</span> <span class="title class_">JwtToken</span>(token));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿™é‡Œè¿”å›trueè¡¨ç¤ºæ‰€æœ‰éªŒè¯ç»“æœéƒ½èƒ½é€šè¿‡, åœ¨controllerä¸­å¯ä»¥ä½¿ç”¨shiroæ³¨è§£é™åˆ¶æ˜¯å¦éœ€è¦ç™»å½•æƒé™</span></span><br><span class="line">        <span class="comment">// è®¾ç½®trueå³å…è®¸æ¸¸å®¢è®¿é—®</span></span><br><span class="line">        <span class="comment">// è®¾ç½®falseåˆ™å¿…é¡»æºå¸¦tokenè¿›è¡ŒéªŒè¯</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Shiroæ ¸å¿ƒé…ç½®"><a href="#Shiroæ ¸å¿ƒé…ç½®" class="headerlink" title="Shiroæ ¸å¿ƒé…ç½®"></a>Shiroæ ¸å¿ƒé…ç½®</h3><p>æ ¸å¿ƒé…ç½® -&gt; <strong>ShiroConfig.java</strong></p>
<ul>
<li>é…ç½®realmè§„åˆ™é“¾</li>
<li>é…ç½®è®¿é—®ç­–ç•¥ï¼šurlå’Œfilter</li>
<li>å¼€å¯shiroæ³¨è§£æ”¯æŒ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.filter.JwtFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.DefaultSessionStorageEvaluator;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.DefaultSubjectDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.LifecycleBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/20 16:48</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: shiroæ ¸å¿ƒé…ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SecurityManager,å®‰å…¨ç®¡ç†å™¨,æ‰€æœ‰ä¸å®‰å…¨ç›¸å…³çš„æ“ä½œéƒ½ä¼šä¸ä¹‹è¿›è¡Œäº¤äº’;</span></span><br><span class="line"><span class="comment">     * å®ƒç®¡ç†ç€æ‰€æœ‰Subject,æ‰€æœ‰Subjectéƒ½ç»‘å®šåˆ°SecurityManager,ä¸Subjectçš„æ‰€æœ‰äº¤äº’éƒ½ä¼šå§”æ‰˜ç»™SecurityManager</span></span><br><span class="line"><span class="comment">     * DefaultWebSecurityManager :</span></span><br><span class="line"><span class="comment">     * ä¼šåˆ›å»ºé»˜è®¤çš„DefaultSubjectDAO(å®ƒåˆä¼šé»˜è®¤åˆ›å»ºDefaultSessionStorageEvaluator)</span></span><br><span class="line"><span class="comment">     * ä¼šé»˜è®¤åˆ›å»ºDefaultWebSubjectFactory</span></span><br><span class="line"><span class="comment">     * ä¼šé»˜è®¤åˆ›å»ºModularRealmAuthenticator</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DefaultWebSecurityManager <span class="title function_">securityManager</span><span class="params">(ShiroRealm shiroRealm)</span> &#123;</span><br><span class="line">        <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">        <span class="comment">// è®¾ç½®realms</span></span><br><span class="line">        securityManager.setRealms(shiroRealm.allRealm());</span><br><span class="line">        <span class="comment">// close session</span></span><br><span class="line">        <span class="type">DefaultSubjectDAO</span> <span class="variable">defaultSubjectDAO</span> <span class="operator">=</span> (DefaultSubjectDAO) securityManager.getSubjectDAO();</span><br><span class="line">        <span class="type">DefaultSessionStorageEvaluator</span> <span class="variable">evaluator</span> <span class="operator">=</span> (DefaultSessionStorageEvaluator) defaultSubjectDAO.getSessionStorageEvaluator();</span><br><span class="line">        evaluator.setSessionStorageEnabled(Boolean.FALSE);</span><br><span class="line">        defaultSubjectDAO.setSessionStorageEvaluator(evaluator);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®Shiroçš„è®¿é—®ç­–ç•¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">filterFactoryBean</span><span class="params">(DefaultWebSecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">factoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">        Map&lt;String, Filter&gt; filterMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;jwt&quot;</span>, <span class="keyword">new</span> <span class="title class_">JwtFilter</span>());</span><br><span class="line">        factoryBean.setFilters(filterMap);</span><br><span class="line">        factoryBean.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; filterRuleMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">        <span class="comment">//ç™»é™†ç›¸å…³apiä¸éœ€è¦è¢«è¿‡æ»¤å™¨æ‹¦æˆª</span></span><br><span class="line">        filterRuleMap.put(<span class="string">&quot;/user/login/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        <span class="comment">// æ‰€æœ‰è¯·æ±‚é€šè¿‡JWT Filter</span></span><br><span class="line">        filterRuleMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;jwt&quot;</span>);</span><br><span class="line">        factoryBean.setFilterChainDefinitionMap(filterRuleMap);</span><br><span class="line">        <span class="keyword">return</span> factoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·»åŠ æ³¨è§£æ”¯æŒ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@DependsOn(&quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title function_">defaultAdvisorAutoProxyCreator</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DefaultAdvisorAutoProxyCreator</span> <span class="variable">advisorAutoProxyCreator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAdvisorAutoProxyCreator</span>();</span><br><span class="line">        advisorAutoProxyCreator.setProxyTargetClass(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> advisorAutoProxyCreator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·»åŠ æ³¨è§£ä¾èµ–</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LifecycleBeanPostProcessor <span class="title function_">lifecycleBeanPostProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LifecycleBeanPostProcessor</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼€å¯æ³¨è§£</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title function_">authorizationAttributeSourceAdvisor</span><span class="params">(DefaultWebSecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">AuthorizationAttributeSourceAdvisor</span> <span class="variable">advisor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthorizationAttributeSourceAdvisor</span>();</span><br><span class="line">        advisor.setSecurityManager(securityManager);</span><br><span class="line">        <span class="keyword">return</span> advisor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><p>å®ç°UserServiceä¸­çš„loginæ–¹æ³• -&gt; <strong>UserServiceImpl.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.model.User;</span><br><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.service.UserService;</span><br><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.wx.model.WxAccount;</span><br><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.wx.service.WxAccountService;</span><br><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.wx.util.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/23 11:19</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JwtUtil jwtUtil;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> WxAccountService wxAccountService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">login</span><span class="params">(String jsCode)</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; res = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">WxAccount</span> <span class="variable">wxAccount</span> <span class="operator">=</span> wxAccountService.login(jsCode);</span><br><span class="line">        log.info(<span class="string">&quot;---&gt;&gt;&gt;wxAccountä¿¡æ¯:[&#123;&#125;]&quot;</span>,wxAccount);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(wxAccount.getOpenId());</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// todo: ç”¨æˆ·ä¸å­˜åœ¨, æé†’ç”¨æˆ·æäº¤æ³¨å†Œä¿¡æ¯</span></span><br><span class="line">            res.put(<span class="string">&quot;canLogin&quot;</span>,Boolean.FALSE.toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.put(<span class="string">&quot;canLogin&quot;</span>,Boolean.TRUE.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        res.put(<span class="string">&quot;token&quot;</span>, jwtUtil.sign(wxAccount));</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºcontrollerï¼Œç¼–å†™æµ‹è¯•api -&gt; <strong>UserController.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.controller.res.CodeMsg;</span><br><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.controller.res.Result;</span><br><span class="line"><span class="keyword">import</span> com.github.gongsir0630.shirodemo.service.UserService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.annotation.RequiresAuthentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ç¨‹åºå‘˜Kyleâœ¨ GitHub: https://github.com/gongsir0630</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/3/23 11:12</span></span><br><span class="line"><span class="comment"> * ä½ çš„æŒ‡å°–,æ‹¥æœ‰æ”¹å˜ä¸–ç•Œçš„åŠ›é‡</span></span><br><span class="line"><span class="comment"> * æè¿°: ç”¨æˆ·ä¿¡æ¯æ¥å£ç±»,åŒ…å«å°ç¨‹åºç™»å½•æ³¨å†Œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»è®¤è¯ä¿¡æ¯ä¸­è·å–ç”¨æˆ·Id: userId == openId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> userId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getUserId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SecurityUtils.getSubject().getPrincipal().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°ç¨‹åºç”¨æˆ·ç™»å½•æ¥å£: é€šè¿‡js_codeæ¢å–openId, åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»æ³¨å†Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code wx.login() å¾—åˆ°çš„codeå‡­è¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Result&lt;JSONObject&gt;&gt; <span class="title function_">login</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(code)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(Result.fail(<span class="keyword">new</span> <span class="title class_">CodeMsg</span>(<span class="number">401</span>,<span class="string">&quot;code is empty&quot;</span>), <span class="literal">null</span>), HttpStatus.OK);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;---&gt;æ¥æ”¶åˆ°æ¥è‡ªå°ç¨‹åºç«¯çš„code:[&#123;&#125;]&quot;</span>,code);</span><br><span class="line">        <span class="comment">// todo: ä½¿ç”¨ code -&gt; wxAccountService.login() -&gt; openId,session_key</span></span><br><span class="line">        Map&lt;String, String&gt; loginMap = userService.login(code);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">canLogin</span> <span class="operator">=</span> Boolean.parseBoolean(loginMap.get(<span class="string">&quot;canLogin&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> loginMap.get(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        data.put(<span class="string">&quot;token&quot;</span>,token);</span><br><span class="line">        data.put(<span class="string">&quot;canLogin&quot;</span>,canLogin);</span><br><span class="line">        log.info(<span class="string">&quot;---&gt;&gt;&gt;è¿”å›è®¤è¯ä¿¡æ¯:[&#123;&#125;]&quot;</span>, data.toString());</span><br><span class="line">        <span class="keyword">if</span> (!canLogin) &#123;</span><br><span class="line">            <span class="comment">// todo: ç”¨æˆ·ä¸å­˜åœ¨,æç¤ºç”¨æˆ·æ³¨å†Œ</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(Result.fail(CodeMsg.NO_USER,data),HttpStatus.OK);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(Result.success(data),HttpStatus.OK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä½¿ç”¨ RequiresAuthentication æ³¨è§£, éœ€è¦éªŒè¯æ‰èƒ½è®¿é—®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> userId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="meta">@RequiresAuthentication</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Result&lt;JSONObject&gt;&gt; <span class="title function_">requireAuth</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        data.put(<span class="string">&quot;hello&quot;</span>,getUserId());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(Result.success(data),HttpStatus.OK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–å†™å°ç¨‹åºæµ‹è¯•ä»£ç è·å–<code>code</code>ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wx.<span class="title function_">login</span>(&#123;</span><br><span class="line">   <span class="attr">timeout</span>: <span class="number">3000</span>,</span><br><span class="line">   <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src= "/blog/img/loading.gif" data-src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ea0c2f0c10e40bb9d898198fd88d731~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>å¯åŠ¨ <a target="_blank" rel="noopener" href="https://github.com/wx-java-miniapp"><code>wx-java-miniapp</code></a>é¡¹ç›®ï¼š</p>
<p><img src= "/blog/img/loading.gif" data-src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef5a62b16daa4687a1924d599037db3e~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>å¯åŠ¨<code>shiro-jwt-demo</code>é¡¹ç›®ï¼š</p>
<p><img src= "/blog/img/loading.gif" data-src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2a4d81669bc4813845add1d598674a0~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>Postmanæµ‹è¯•è®¤è¯ï¼š</p>
<p><img src= "/blog/img/loading.gif" data-src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4f23e79dc4fb4494951768161c67b2f6~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<p>æºå¸¦tokenè®¿é—®ï¼š</p>
<p><img src= "/blog/img/loading.gif" data-src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/70eb9247eedc431d803bfc61484f2ee1~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ä»¥ä¸Šå°±æ˜¯åŸºäºShiroã€JWTå®ç°å¾®ä¿¡å°ç¨‹åºç™»å½•å®Œæ•´ä¾‹å­çš„é€»è¾‘è¿‡ç¨‹è¯´æ˜åŠå…¶å®ç°ã€‚</p>
<ul>
<li>å®Œæ•´é¡¹ç›®åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/gongsir0630/shiro-jwt-demo">https://github.com/gongsir0630/shiro-jwt-demo</a></li>
</ul>
</div>
        
  </div>

    <div class="post_tags">
      
        <i class="fas fa-tag"></i> <a href="/blog/tags/Java/" class="tag">Java</a>
      
        <i class="fas fa-tag"></i> <a href="/blog/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" class="tag">å¾®ä¿¡å°ç¨‹åº</a>
      
    </div>
    <div class="post-nav">
      
        <div class="post-nav-prev post-nav-item">
            <a href="/blog/2021/04/02/travis-ci-springboot.html" >ä½¿ç”¨ Travis æ‰“é€  SpringBoot åº”ç”¨æŒç»­é›†æˆå’Œè‡ªåŠ¨éƒ¨ç½² | Travis CI åˆä½“éªŒ<i class="fa fa-chevron-left"></i></a>
        </div>
      
      
        <div class="post-nav-next post-nav-item">
            <a href="/blog/2021/03/07/my-college-days.html" >è£è€€åŠ å†•ï¼Œè¿½æ¢¦ä¸ä¼‘ | æˆ‘çš„å¤§å­¦æ—¶å…‰<i class="fa fa-chevron-right"></i></a>
        </div>
      
    </div>
      



  <div id="valine"></div>
  <script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script>
  <script>
        new Valine({
          el: '#valine',
          appId: "7sd5RvAKvPf0dty5f4QfFL7R-gzGzoHsz",
          appKey: "gjLXJe9CumUibqTPtE6TmIQn",
          avatar: "robohash",
          lang: "",
          meta: 'nick,mail,link'.split(','),
          requiredFields: 'nick,mail'.split(','),
          placeholder: "è¯„è®ºè®°å¾—å¸¦ä¸Šé‚®ç®±,ä½ çš„ç•™è¨€æˆ‘ä¼šé©¬ä¸Šæ”¶åˆ°é‚®ç®±æé†’å“’",
          pageSize:'10',
          recordIP: 'false',
          serverURLs: "https://blog.gongsir.club",
          emojiCDN: "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/",
          enableQQ: "true",
        });
  </script>
  

</article>

    
<a id="gotop" href="javascript:" title="è¿”å›é¡¶éƒ¨"><i class="fa fa-arrow-up"></i></a>
    






    
<div id="bottom-outer">
    <div id="bottom-inner">
        Â© 2020 <i class="fa fa-heart" id="heart"></i> ç¨‹åºå‘˜Kyleâœ¨ 
        <br>
        Powered by 
        <a target="_blank" rel="noopener" href="http://hexo.io">hexo</a> | Theme is <a target="_blank" rel="noopener" href="https://github.com/a2396837/hexo-theme-blank/">blank</a>
        
          <div class="icp-info">
            
            <img  class="icp-icon" src="/img/icp.png">
            
          <a href="http://www.beian.miit.gov.cn/" target="_blank"> èœ€ICPå¤‡19016450å·</a>
        </div>
        
    </div>  
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/layui-src@2.5.5/dist/layui.min.js"></script>



  
    <script src="/blog/js/script.js"></script>
  
    <script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script>
  

 

  <script src="/blog/js/local-search.js"></script>
<script type="text/javascript">      
  var search_path = "search.xml";
if (search_path.length == 0) {
  search_path = "search.xml";
}
var path = "/blog/" + search_path;
  searchFunc(path, 'local-search-input', 'local-search-result');
</script>
  


  <script>
    window.lazyLoadOptions = {
      elements_selector: 'img',
      threshold: 0
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script>   
  


  <script>
    var images = $('img').not('.nav-logo img').not('.card img').not($('a>img')).not('.reward-content img')
    images.each(function (i, o) {
      var lazyloadSrc = $(o).attr('data-src') ? $(o).attr('data-src') : $(o).attr('src')
      $(o).wrap(`<a href="${lazyloadSrc}" data-fancybox="group" data-caption="${$(o).attr('alt')}" class="fancybox"></a>`)
    })
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script>
  <script>
        $().fancybox({
      selector: '[data-fancybox]',
      loop: true,
      transitionEffect: 'slide',
      protect: true,
      buttons: ['slideShow', 'fullScreen', 'thumbs', 'close']
    })
  </script>   
  


  <script>
  if (!window.MathJax) {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]],
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
              const display = !!node.type.match(/; *mode=display/)
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
              const text = document.createTextNode('')
              node.parentNode.replaceChild(text, node)
              math.start = {node: text, delim: '', n: 0}
              math.end = {node: text, delim: '', n: 0}
              doc.math.push(math)
            }
          }, '']
        }
      }
    }
    
    var script = document.createElement('script')
    script.src = "https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js"
    script.id = 'MathJax-script'
    script.async = true
    document.head.appendChild(script)
  } else {
    MathJax.startup.document.state(0)
    MathJax.texReset()
    MathJax.typeset()
  }
  </script>
  


  
<script>
if (document.getElementsByClassName('mermaid').length) {
    if (window.mermaidJsLoad) mermaid.init()
    else {
      $.getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js", function () {
        window.mermaidJsLoad = true
        mermaid.initialize({
          theme: "default",
        })
      })
    }
  }
  </script>
  






  <script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script>
  


  <script src="https://cdn.jsdelivr.net/gh/a2396837/CDN@latest/js/firework.js"></script>
  


  
<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js"></script>
<script>
!function (e, t, a) {
  var initCopyCode = function(){
    var copyHtml = '';
    copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
    copyHtml += '  <i class="fa fa-clipboard"></i><span>å¤åˆ¶</span>';
    copyHtml += '</button>';
    $(".highlight .code pre").before(copyHtml);
    new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
  }
  initCopyCode();
}(window, document);
</script>  
  

<script>
  var btntop = $('#gotop');
  btntop.on('click', function (e) {
    e.preventDefault();
    $('html, body').animate({ scrollTop: 0 }, '300');
  });

  var $table = $('.content table').not($('figure.highlight > table'))
$table.each(function () {
  $(this).wrap('<div class="table-wrap"></div>')
})
</script>



</html>